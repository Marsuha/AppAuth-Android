/*
 * Copyright 2015 The AppAuth for Android Authors. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except
 * in compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the
 * License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.openid.appauth

import net.openid.appauth.AuthorizationRequest.Companion.jsonDeserialize
import net.openid.appauth.AuthorizationRequest.Prompt.CONSENT
import net.openid.appauth.AuthorizationRequest.Prompt.LOGIN
import net.openid.appauth.AuthorizationRequest.Prompt.SELECT_ACCOUNT
import net.openid.appauth.CodeVerifierUtil.codeVerifierChallengeMethod
import net.openid.appauth.CodeVerifierUtil.deriveCodeVerifierChallenge
import net.openid.appauth.TestValues.TEST_APP_REDIRECT_URI
import net.openid.appauth.TestValues.TEST_CLIENT_ID
import net.openid.appauth.TestValues.TEST_EMAIL_ADDRESS
import net.openid.appauth.TestValues.TEST_NONCE
import net.openid.appauth.TestValues.TEST_STATE
import net.openid.appauth.TestValues.testServiceConfig
import org.assertj.core.api.Assertions.assertThat
import org.json.JSONException
import org.json.JSONObject
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [28])
class AuthorizationRequestTest {
    private lateinit var requestBuilder: AuthorizationRequest.Builder

    @Before
    fun setUp() {
        requestBuilder = AuthorizationRequest.Builder(
            testServiceConfig,
            TEST_CLIENT_ID,
            ResponseTypeValues.CODE,
            TEST_APP_REDIRECT_URI
        )
    }

    /* ********************************** Builder() ***********************************************/
    @Test(expected = IllegalArgumentException::class)
    fun testBuilder_emptyClientId() {
        AuthorizationRequest.Builder(
            testServiceConfig,
            "",
            ResponseTypeValues.CODE,
            TEST_APP_REDIRECT_URI
        )
    }

    @Test(expected = IllegalArgumentException::class)
    fun testBuilder_emptyResponseType() {
        AuthorizationRequest.Builder(
            testServiceConfig,
            TEST_CLIENT_ID,
            "",
            TEST_APP_REDIRECT_URI
        )
    }

    /* ************************************** clientId ********************************************/
    @Test
    fun testClientId_fromConstructor() {
        val request = requestBuilder.build()
        assertThat(request.clientId).isEqualTo(TEST_CLIENT_ID)
    }

    @Test(expected = IllegalArgumentException::class)
    fun testClientId_empty() {
        requestBuilder.setClientId("").build()
    }

    /* ************************************** codeVerifier ****************************************/
    @Test
    fun testCodeVerifier_autoGenerated() {
        val request = requestBuilder.build()
        assertThat(request.codeVerifier).isNotEmpty()
        assertThat(request.codeVerifierChallenge).isNotEmpty()
        assertThat(request.codeVerifierChallengeMethod).isNotEmpty()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testCodeVerifier_tooShort() {
        requestBuilder
            .setCodeVerifier(generateString(CodeVerifierUtil.MIN_CODE_VERIFIER_LENGTH - 1))
            .build()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testCodeVerifier_tooLong() {
        requestBuilder
            .setCodeVerifier(generateString(CodeVerifierUtil.MAX_CODE_VERIFIER_LENGTH + 1))
            .build()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testCodeVerifier_illegalChars() {
        requestBuilder.setCodeVerifier("##ILLEGAL!$!").build()
    }

    @Test
    fun testCodeVerifier_disabled() {
        val request = requestBuilder
            .setCodeVerifier(null)
            .build()
        assertThat(request.codeVerifier).isNull()
        assertThat(request.codeVerifierChallenge).isNull()
        assertThat(request.codeVerifierChallengeMethod).isNull()
    }

    @Test
    fun testCodeVerifier_customized() {
        val request = requestBuilder
            .setCodeVerifier(TEST_CODE_VERIFIER, "myChallenge", "myChallengeMethod")
            .build()
        assertThat(request.codeVerifier).isEqualTo(TEST_CODE_VERIFIER)
        assertThat(request.codeVerifierChallenge).isEqualTo("myChallenge")
        assertThat(request.codeVerifierChallengeMethod).isEqualTo("myChallengeMethod")
    }

    @Test(expected = IllegalArgumentException::class)
    fun testCodeVerifier_withoutCodeChallenge() {
        requestBuilder
            .setCodeVerifier(
                TEST_CODE_VERIFIER,
                null,
                codeVerifierChallengeMethod
            )
            .build()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testCodeVerifier_withoutCodeChallengeMethod() {
        requestBuilder
            .setCodeVerifier(
                TEST_CODE_VERIFIER,
                deriveCodeVerifierChallenge(TEST_CODE_VERIFIER),
                null
            )
            .build()
    }

    /* ************************************** display *********************************************/
    @Test
    fun testDisplay_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.display).isNull()
    }

    @Test
    fun testDisplay() {
        val req = requestBuilder
            .setDisplay(AuthorizationRequest.Display.TOUCH)
            .build()
        assertThat(req.display).isEqualTo(AuthorizationRequest.Display.TOUCH)
    }

    @Test
    fun testDisplay_withNullValue() {
        val req = requestBuilder
            .setDisplay(null)
            .build()

        assertThat(req.display).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testDisplay_withEmptyValue() {
        requestBuilder.setDisplay("").build()
    }

    /* ***********************************  login_hint ********************************************/
    @Test
    fun testLoginHint_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.loginHint).isNull()
    }

    @Test
    fun testLoginHint() {
        val req = requestBuilder
            .setLoginHint(TEST_EMAIL_ADDRESS)
            .build()
        assertThat(req.loginHint).isEqualTo(TEST_EMAIL_ADDRESS)
    }

    @Test
    fun testLoginHint_withNullValue() {
        val req = requestBuilder
            .setLoginHint(null)
            .build()

        assertThat(req.loginHint).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testLoginHint_withEmptyValue() {
        requestBuilder.setLoginHint("").build()
    }

    /* ************************************** prompt **********************************************/
    @Test
    fun testPrompt_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.prompt).isNull()
        assertThat(request.promptValues).isNull()
    }

    @Test
    fun testPrompt() {
        val req = requestBuilder
            .setPrompt(LOGIN)
            .build()

        assertThat(req.prompt).isEqualTo(LOGIN)
        assertThat(req.promptValues)
            .hasSize(1)
            .contains(LOGIN)
    }

    @Test
    fun testPrompt_nullValue() {
        val req = requestBuilder.setPrompt(null).build()
        assertThat(req.prompt).isNull()
        assertThat(req.promptValues).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testPrompt_empty() {
        requestBuilder.setPrompt("").build()
    }

    @Test
    fun testPrompt_withVarargs() {
        val req = requestBuilder
            .setPromptValues(
                LOGIN,
                CONSENT
            )
            .build()

        assertThat(req.prompt).isEqualTo("$LOGIN $CONSENT")

        assertThat(req.promptValues)
            .hasSize(2)
            .contains(LOGIN)
            .contains(CONSENT)
    }

    @Test(expected = IllegalArgumentException::class)
    fun testPrompt_withEmptyStringInVarargs() {
        requestBuilder.setPromptValues(LOGIN, "").build()
    }

    @Test
    fun testPrompt_withIterable() {
        val req = requestBuilder
            .setPromptValues(listOf(SELECT_ACCOUNT, CONSENT))
            .build()

        assertThat(req.prompt).isEqualTo("$SELECT_ACCOUNT $CONSENT")

        assertThat(req.promptValues)
            .hasSize(2)
            .contains(SELECT_ACCOUNT)
            .contains(CONSENT)
    }

    @Test(expected = IllegalArgumentException::class)
    fun testPrompt_withIterableContainingEmptyValue() {
        requestBuilder
            .setPromptValues(listOf(SELECT_ACCOUNT, ""))
            .build()
    }

    /* ******************************** ui_locales ***********************************************/
    @Test
    fun testUiLocales_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.uiLocales).isNull()
        assertThat(request.uiLocalesValues).isNull()
    }

    @Test
    fun testUiLocales() {
        val req = requestBuilder
            .setUiLocales("en de fr-CA")
            .build()

        assertThat(req.uiLocales).isEqualTo("en de fr-CA")
        assertThat(req.uiLocalesValues)
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test
    fun testUiLocales_nullValue() {
        val req = requestBuilder.setUiLocales(null).build()
        assertThat(req.uiLocales).isNull()
        assertThat(req.uiLocalesValues).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testUiLocales_empty() {
        requestBuilder.setUiLocales("").build()
    }

    @Test
    fun testUiLocales_withVarargs() {
        val req = requestBuilder
            .setUiLocalesValues("en", "de", "fr-CA")
            .build()

        assertThat(req.uiLocales).isEqualTo("en de fr-CA")
        assertThat(req.uiLocalesValues)
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test(expected = IllegalArgumentException::class)
    fun testUiLocales_withEmptyStringInVarargs() {
        requestBuilder.setUiLocalesValues("en", "").build()
    }

    @Test
    fun testUiLocales_withIterable() {
        val req = requestBuilder
            .setUiLocalesValues(mutableListOf("en", "de", "fr-CA"))
            .build()

        assertThat(req.uiLocales).isEqualTo("en de fr-CA")

        assertThat(req.uiLocalesValues)
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test(expected = IllegalArgumentException::class)
    fun testUiLocales_withIterableContainingEmptyValue() {
        requestBuilder
            .setUiLocalesValues(mutableListOf("en", ""))
            .build()
    }

    /* ******************************** redirectUri ***********************************************/
    @Test
    fun testRedirectUri_fromConstructor() {
        val request = requestBuilder.build()
        assertThat(request.redirectUri).isEqualTo(TEST_APP_REDIRECT_URI)
    }

    /* ******************************* responseMode ***********************************************/
    @Test(expected = IllegalArgumentException::class)
    fun testBuilder_emptyResponseMode() {
        requestBuilder.setResponseMode("").build()
    }

    /* ******************************* responseType ***********************************************/
    @Test
    fun testResponseType() {
        val request = requestBuilder.build()
        assertThat(request.responseType).isEqualTo(ResponseTypeValues.CODE)
    }

    /* *********************************** scope **************************************************/

    @Test
    fun testScope_empty() {
        val request = requestBuilder.setScopes().build()
        assertThat(request.scope).isNull()
    }

    @Test
    fun testScope_emptyList() {
        val request: AuthorizationRequest = requestBuilder.setScopes(emptyList()).build()
        assertThat(request.scope).isNull()
    }

    /* *********************************** state **************************************************/
    @Test
    fun testState_autoGenerated() {
        val request = requestBuilder.build()
        assertThat(request.state).isNotEmpty()
    }

    /* *********************************** nonce **************************************************/
    @Test
    fun testNonce_autoGenerated() {
        val request = requestBuilder.build()
        assertThat(request.nonce).isNotEmpty()
    }

    /* ********************************** claims **************************************************/
    @Test
    fun testClaims_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.claims).isNull()
    }

    @Test
    @Throws(JSONException::class)
    fun testClaims() {
        val claims = JSONObject(TEST_CLAIMS)
        val req = requestBuilder.setClaims(claims).build()
        assertThat(req.claims.toString()).isEqualTo(claims.toString())
    }

    @Test
    fun testClaims_withNullValue() {
        val req = requestBuilder.setClaims(null).build()
        assertThat(req.claims).isNull()
    }

    /* ******************************* claims_locales *********************************************/
    @Test
    fun testClaimsLocales_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.claimsLocales).isNull()
        assertThat(request.claimsLocalesValues).isNull()
    }

    @Test
    fun testClaimsLocales() {
        val req = requestBuilder
            .setClaimsLocales("en de fr-CA")
            .build()

        assertThat(req.claimsLocales).isEqualTo("en de fr-CA")

        assertThat(req.claimsLocalesValues)
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test
    fun testClaimsLocales_nullValue() {
        val req = requestBuilder.setClaimsLocales(null).build()
        assertThat(req.claimsLocales).isNull()
        assertThat(req.claimsLocalesValues).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testClaimsLocales_empty() {
        requestBuilder.setClaimsLocales("").build()
    }

    @Test
    fun testClaimsLocales_withVarargs() {
        val req = requestBuilder
            .setClaimsLocalesValues("en", "de", "fr-CA")
            .build()

        assertThat(req.claimsLocales).isEqualTo("en de fr-CA")

        assertThat(req.claimsLocalesValues)
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test(expected = IllegalArgumentException::class)
    fun testClaimsLocales_withEmptyStringInVarargs() {
        requestBuilder.setClaimsLocalesValues("en", "").build()
    }

    @Test
    fun testClaimsLocales_withIterable() {
        val req = requestBuilder
            .setClaimsLocalesValues(mutableListOf("en", "de", "fr-CA"))
            .build()

        assertThat(req.claimsLocales).isEqualTo("en de fr-CA")

        assertThat(req.claimsLocalesValues)
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test(expected = IllegalArgumentException::class)
    fun testClaimsLocales_withIterableContainingEmptyValue() {
        requestBuilder.setClaimsLocalesValues(mutableListOf("en", "")).build()
    }

    /* ******************************* additionalParams *******************************************/
    @Test(expected = IllegalArgumentException::class)
    fun testBuilder_setAdditionalParams_withBuiltInParam() {
        val additionalParams =
            mapOf(AuthorizationRequest.PARAM_SCOPE to AuthorizationRequest.Scope.EMAIL)

        requestBuilder.setAdditionalParameters(additionalParams)
    }

    /* ******************************* toUri() ****************************************************/
    @Test
    @Throws(Exception::class)
    fun testToUri() {
        val request = requestBuilder.build()
        val uri = request.toUri()

        assertThat(uri.getQueryParameterNames())
            .isEqualTo(
                setOf(
                    AuthorizationRequest.PARAM_CLIENT_ID,
                    AuthorizationRequest.PARAM_RESPONSE_TYPE,
                    AuthorizationRequest.PARAM_REDIRECT_URI,
                    AuthorizationRequest.PARAM_STATE,
                    AuthorizationRequest.PARAM_NONCE,
                    AuthorizationRequest.PARAM_CODE_CHALLENGE,
                    AuthorizationRequest.PARAM_CODE_CHALLENGE_METHOD
                )
            )

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_CLIENT_ID))
            .isEqualTo(TEST_CLIENT_ID)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_RESPONSE_TYPE))
            .isEqualTo(ResponseTypeValues.CODE)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_REDIRECT_URI))
            .isEqualTo(TEST_APP_REDIRECT_URI.toString())

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_STATE))
            .isEqualTo(request.state)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_NONCE))
            .isEqualTo(request.nonce)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_CODE_CHALLENGE))
            .isEqualTo(request.codeVerifierChallenge)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_CODE_CHALLENGE_METHOD))
            .isEqualTo(request.codeVerifierChallengeMethod)
    }

    @Test
    @Throws(Exception::class)
    fun testToUri_noCodeVerifier() {
        val req = requestBuilder.setCodeVerifier(null).build()

        assertThat(req.toUri().getQueryParameterNames())
            .doesNotContain(AuthorizationRequest.PARAM_CODE_CHALLENGE)
            .doesNotContain(AuthorizationRequest.PARAM_CODE_CHALLENGE_METHOD)
    }

    @Test
    fun testToUri_displayParam() {
        val uri = requestBuilder
            .setDisplay(AuthorizationRequest.Display.PAGE)
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames())
            .contains(AuthorizationRequest.PARAM_DISPLAY)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_DISPLAY))
            .isEqualTo(AuthorizationRequest.Display.PAGE)
    }

    @Test
    fun testToUri_loginHint() {
        val uri = requestBuilder
            .setLoginHint(TEST_EMAIL_ADDRESS)
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_LOGIN_HINT)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_LOGIN_HINT))
            .isEqualTo(TEST_EMAIL_ADDRESS)
    }


    @Test
    fun testToUri_promptParam() {
        val uri = requestBuilder
            .setPrompt(CONSENT)
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_PROMPT)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_PROMPT))
            .isEqualTo(CONSENT)
    }

    @Test
    fun testToUri_uiLocalesParam() {
        val uri = requestBuilder
            .setUiLocales("en de fr-CA")
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_UI_LOCALES)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_UI_LOCALES))
            .isEqualTo("en de fr-CA")
    }

    @Test
    fun testToUri_responseModeParam() {
        val uri = requestBuilder
            .setResponseMode(AuthorizationRequest.ResponseMode.QUERY)
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_RESPONSE_MODE)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_RESPONSE_MODE))
            .isEqualTo(AuthorizationRequest.ResponseMode.QUERY)
    }

    @Test
    fun testToUri_scopeParam() {
        val uri = requestBuilder
            .setScope(AuthorizationRequest.Scope.EMAIL)
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_SCOPE)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_SCOPE))
            .isEqualTo(AuthorizationRequest.Scope.EMAIL)
    }

    @Test
    fun testToUri_stateParam() {
        val uri = requestBuilder
            .setState(TEST_STATE)
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_STATE)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_STATE))
            .isEqualTo(TEST_STATE)
    }

    @Test
    @Throws(Exception::class)
    fun testToUri_noStateParam() {
        val req = requestBuilder.setState(null).build()
        assertThat(req.toUri().getQueryParameterNames())
            .doesNotContain(AuthorizationRequest.PARAM_STATE)
    }

    @Test
    fun testToUri_nonceParam() {
        val uri = requestBuilder.setNonce(TEST_NONCE).build().toUri()
        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_NONCE)
        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_NONCE))
            .isEqualTo(TEST_NONCE)
    }

    @Test
    @Throws(Exception::class)
    fun testToUri_noNonceParam() {
        val req = requestBuilder.setNonce(null).build()

        assertThat(req.toUri().getQueryParameterNames())
            .doesNotContain(AuthorizationRequest.PARAM_NONCE)
    }

    @Test
    @Throws(JSONException::class)
    fun testToUri_claimsParam() {
        val req = requestBuilder
            .setClaims(JSONObject(TEST_CLAIMS))
            .build()

        val uri = req.toUri()
        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_CLAIMS)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_CLAIMS))
            .isEqualTo(req.claims.toString())
    }

    @Test
    fun testToUri_claimsLocalesParam() {
        val uri = requestBuilder
            .setClaimsLocales("en de fr-CA")
            .build()
            .toUri()

        assertThat(uri.getQueryParameterNames()).contains(AuthorizationRequest.PARAM_CLAIMS_LOCALES)

        assertThat(uri.getQueryParameter(AuthorizationRequest.PARAM_CLAIMS_LOCALES))
            .isEqualTo("en de fr-CA")
    }

    @Test
    @Throws(Exception::class)
    fun testToUri_additionalParams() {
        val additionalParams = mapOf(
            "my_param" to "1234",
            "another_param" to "5678"
        )

        val req = requestBuilder
            .setAdditionalParameters(additionalParams)
            .build()

        val uri = req.toUri()

        assertThat(uri.getQueryParameter("my_param")).isEqualTo("1234")
        assertThat(uri.getQueryParameter("another_param")).isEqualTo("5678")
    }

    /* ************************** jsonSerialize() / jsonDeserialize() *****************************/
    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_clientId() {
        val copy = serializeDeserialize(requestBuilder.setClientId(TEST_CLIENT_ID).build())
        assertThat(copy.clientId).isEqualTo(TEST_CLIENT_ID)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_display() {
        val copy = serializeDeserialize(
            requestBuilder.setDisplay(AuthorizationRequest.Display.POPUP).build()
        )

        assertThat(copy.display).isEqualTo(AuthorizationRequest.Display.POPUP)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_loginHint() {
        val copy = serializeDeserialize(
            requestBuilder.setLoginHint(TEST_EMAIL_ADDRESS).build()
        )

        assertThat(copy.loginHint).isEqualTo(TEST_EMAIL_ADDRESS)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_prompt() {
        val copy = serializeDeserialize(
            requestBuilder.setPrompt(CONSENT).build()
        )
        assertThat(copy.prompt).isEqualTo(CONSENT)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_uiLocales() {
        val copy = serializeDeserialize(
            requestBuilder.setUiLocales("en de fr-CA").build()
        )
        assertThat(copy.uiLocales).isEqualTo("en de fr-CA")
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_redirectUri() {
        val copy = serializeDeserialize(
            requestBuilder.setRedirectUri(TEST_APP_REDIRECT_URI).build()
        )
        assertThat(copy.redirectUri).isEqualTo(TEST_APP_REDIRECT_URI)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_responseMode() {
        val copy = serializeDeserialize(
            requestBuilder.setResponseMode(AuthorizationRequest.ResponseMode.QUERY).build()
        )
        assertThat(copy.responseMode).isEqualTo(AuthorizationRequest.ResponseMode.QUERY)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_responseType() {
        val copy = serializeDeserialize(
            requestBuilder.setResponseType(ResponseTypeValues.CODE).build()
        )
        assertThat(copy.responseType).isEqualTo(ResponseTypeValues.CODE)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_scope() {
        val copy = serializeDeserialize(
            requestBuilder.setScope(AuthorizationRequest.Scope.EMAIL).build()
        )
        assertThat(copy.scope).isEqualTo(AuthorizationRequest.Scope.EMAIL)
    }

    @Test
    @Throws(Exception::class)
    fun testSerialization_scopeEmpty() {
        val copy = serializeDeserialize(requestBuilder.setScopes(emptyList()).build())
        assertThat(copy.scope).isNull()
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_state() {
        val copy = serializeDeserialize(requestBuilder.setState(TEST_STATE).build())
        assertThat(copy.state).isEqualTo(TEST_STATE)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_nonce() {
        val copy = serializeDeserialize(requestBuilder.setNonce(TEST_NONCE).build())
        assertThat(copy.nonce).isEqualTo(TEST_NONCE)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_claims() {
        val claims = JSONObject(TEST_CLAIMS)
        val copy = serializeDeserialize(requestBuilder.setClaims(claims).build())
        assertThat(copy.claims.toString()).isEqualTo(claims.toString())
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_claimsLocales() {
        val copy = serializeDeserialize(
            requestBuilder.setClaimsLocales("en de fr-CA").build()
        )
        assertThat(copy.claimsLocales).isEqualTo("en de fr-CA")
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_additionalParams() {
        val copy = serializeDeserialize(
            requestBuilder.setAdditionalParameters(TEST_ADDITIONAL_PARAMS).build()
        )
        assertThat(copy.additionalParameters).isEqualTo(
            TEST_ADDITIONAL_PARAMS
        )
    }

    @Throws(JSONException::class)
    private fun serializeDeserialize(request: AuthorizationRequest): AuthorizationRequest {
        return jsonDeserialize(request.jsonSerializeString())
    }

    private fun generateString(length: Int): String {
        val chars = CharArray(length)
        for (i in chars.indices) {
            chars[i] = '0'
        }

        return String(chars)
    }

    companion object {
        /**
         * Contains all legal characters for a code verifier.
         * @see [RFC 7636, Section 4.1](https://tools.ietf.org/html/rfc7636.section-4.1)
         */
        private const val TEST_CODE_VERIFIER =
            "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_~."

        private val TEST_ADDITIONAL_PARAMS = mapOf(
            "test_key1" to "test_value1",
            "test_key2" to "test_value2"
        )

        private const val TEST_CLAIMS = ("{\n"
                + " \"userinfo\":{\"email\":{\"essential\":true}},\n"
                + " \"id_token\":{\"gender\":null}\n"
                + "}")
    }
}
