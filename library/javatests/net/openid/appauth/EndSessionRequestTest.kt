package net.openid.appauth

import net.openid.appauth.EndSessionRequest.Companion.PARAM_ID_TOKEN_HINT
import net.openid.appauth.EndSessionRequest.Companion.PARAM_POST_LOGOUT_REDIRECT_URI
import net.openid.appauth.EndSessionRequest.Companion.PARAM_STATE
import net.openid.appauth.EndSessionRequest.Companion.jsonDeserialize
import net.openid.appauth.TestValues.TEST_APP_REDIRECT_URI
import net.openid.appauth.TestValues.TEST_ID_TOKEN
import net.openid.appauth.TestValues.TEST_STATE
import net.openid.appauth.TestValues.testEndSessionRequest
import net.openid.appauth.TestValues.testServiceConfig
import org.assertj.core.api.Assertions.assertThat
import org.json.JSONException
import org.junit.Before
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [16])
class EndSessionRequestTest {
    private lateinit var requestBuilder: EndSessionRequest.Builder

    @Before
    fun setUp() {
        requestBuilder = EndSessionRequest.Builder(testServiceConfig)
    }

    /* ******************************** id_token_hint *********************************************/
    @Test
    fun testIdTokenHint_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.idTokenHint).isNull()
    }

    @Test
    fun testIdTokenHint() {
        val request = requestBuilder
            .setIdTokenHint(TEST_ID_TOKEN)
            .build()

        assertThat(request.idTokenHint).isEqualTo(TEST_ID_TOKEN)
    }

    @Test(expected = IllegalArgumentException::class)
    fun testIdTokenHint_empty() {
        requestBuilder.setIdTokenHint("").build()
    }

    /* *************************** post_logout_redirect_uri ***************************************/
    @Test
    fun testPostLogoutRedirectUri_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.postLogoutRedirectUri).isNull()
    }

    @Test
    fun testPostLogoutRedirectUri() {
        val request = requestBuilder
            .setPostLogoutRedirectUri(TEST_APP_REDIRECT_URI)
            .build()

        assertThat(request.postLogoutRedirectUri).isEqualTo(TEST_APP_REDIRECT_URI)
    }

    /* *********************************** state **************************************************/
    @Test
    fun testState_autoGenerated() {
        val request = requestBuilder.build()
        assertThat(request.state).isNotEmpty()
    }

    @Test
    fun testState() {
        val request = requestBuilder
            .setState(TEST_STATE)
            .build()

        assertThat(request.state).isEqualTo(TEST_STATE)
    }

    @Test(expected = IllegalArgumentException::class)
    fun testState_empty() {
        requestBuilder.setState("").build()
    }

    /* ******************************** ui_locales ************************************************/
    @Test
    fun testUiLocales_unspecified() {
        val request = requestBuilder.build()
        assertThat(request.uiLocales).isNull()
        assertThat(request.getUiLocales()).isNull()
    }

    @Test
    fun testUiLocales() {
        val req = requestBuilder
            .setUiLocales("en de fr-CA")
            .build()

        assertThat(req.uiLocales).isEqualTo("en de fr-CA")
        assertThat(req.getUiLocales())
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test
    fun testUiLocales_nullValue() {
        val req = requestBuilder.setUiLocales(null).build()
        assertThat(req.uiLocales).isNull()
        assertThat(req.getUiLocales()).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testUiLocales_empty() {
        requestBuilder.setUiLocales("").build()
    }

    @Test
    fun testUiLocales_withVarargs() {
        val req = requestBuilder
            .setUiLocalesValues("en", "de", "fr-CA")
            .build()

        assertThat(req.uiLocales).isEqualTo("en de fr-CA")
        assertThat(req.getUiLocales())
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test
    fun testUiLocales_withNullVarargsArray() {
        val req: EndSessionRequest = requestBuilder.setUiLocalesValues(null).build()
        assertThat(req.uiLocales).isNull()
        assertThat(req.getUiLocales()).isNull()
    }

    @Test(expected = IllegalArgumentException::class)
    fun testUiLocales_withEmptyStringInVarargs() {
        requestBuilder.setUiLocalesValues("en", "").build()
    }

    @Test
    fun testUiLocales_withIterable() {
        val req = requestBuilder
            .setUiLocalesValues(mutableListOf("en", "de", "fr-CA"))
            .build()

        assertThat(req.uiLocales).isEqualTo("en de fr-CA")

        assertThat(req.getUiLocales())
            .hasSize(3)
            .contains("en")
            .contains("de")
            .contains("fr-CA")
    }

    @Test(expected = IllegalArgumentException::class)
    fun testUiLocales_withIterableContainingEmptyValue() {
        requestBuilder
            .setUiLocalesValues(mutableListOf("en", ""))
            .build()
    }

    /* ******************************* additionalParams *******************************************/
    @Test(expected = IllegalArgumentException::class)
    fun testBuilder_setAdditionalParams_withBuiltInParam() {
        val additionalParams = mapOf(PARAM_STATE to TEST_STATE)
        requestBuilder.setAdditionalParameters(additionalParams)
    }

    /* ******************************* toUri() ****************************************************/
    @Test
    fun testToUri() {
        val request = testEndSessionRequest
        val requestUri = request.toUri()!!

        assertThat(requestUri.getQueryParameter(PARAM_ID_TOKEN_HINT)).isEqualTo(request.idTokenHint)
        assertThat(requestUri.getQueryParameter(PARAM_POST_LOGOUT_REDIRECT_URI))
            .isEqualTo(request.postLogoutRedirectUri.toString())

        assertThat(requestUri.getQueryParameter(PARAM_STATE)).isEqualTo(request.state)
    }

    @Test
    @Throws(Exception::class)
    fun testToUri_noState() {
        val req = requestBuilder.setState(null).build()

        assertThat(req.toUri()?.getQueryParameterNames())
            .doesNotContain(AuthorizationRequest.PARAM_STATE)
    }

    @Test
    fun testToUri_uiLocalesParam() {
        val uri = requestBuilder
            .setUiLocales("en de fr-CA")
            .build()
            .toUri()

        assertThat(uri?.getQueryParameterNames())
            .contains(EndSessionRequest.PARAM_UI_LOCALES)

        assertThat(uri?.getQueryParameter(EndSessionRequest.PARAM_UI_LOCALES))
            .isEqualTo("en de fr-CA")
    }

    @Test
    @Throws(Exception::class)
    fun testToUri_additionalParams() {
        val additionalParams = mapOf("my_param" to "1234", "another_param" to "5678")
        val req = requestBuilder
            .setAdditionalParameters(additionalParams)
            .build()

        val uri = req.toUri()
        assertThat(uri?.getQueryParameter("my_param")).isEqualTo("1234")
        assertThat(uri?.getQueryParameter("another_param")).isEqualTo("5678")
    }

    /* ************************** jsonSerialize() / jsonDeserialize() *****************************/
    @Test
    @Throws(Exception::class)
    fun testJsonSerialize() {
        val request = testEndSessionRequest
        val copy = serializeDeserialize(request)
        assertThat(copy.idTokenHint).isEqualTo(TEST_ID_TOKEN)
        assertThat(copy.state).isEqualTo(request.state)
        assertThat(copy.postLogoutRedirectUri).isEqualTo(request.postLogoutRedirectUri)
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_uiLocales() {
        val copy = serializeDeserialize(requestBuilder.setUiLocales("en de fr-CA").build())
        assertThat(copy.uiLocales).isEqualTo("en de fr-CA")
    }

    @Test
    @Throws(Exception::class)
    fun testJsonSerialize_additionalParams() {
        val additionalParams = mapOf("my_param" to "1234", "another_param" to "5678")
        val copy = serializeDeserialize(
            requestBuilder.setAdditionalParameters(additionalParams).build()
        )
        assertThat(copy.additionalParameters).isEqualTo(additionalParams)
    }

    @Throws(JSONException::class)
    private fun serializeDeserialize(request: EndSessionRequest): EndSessionRequest {
        return jsonDeserialize(request.jsonSerializeString())
    }
}
